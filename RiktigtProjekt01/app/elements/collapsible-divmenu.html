<dom-module name="LPA-milestones">
  <style is="custom-style">

    paper-icon-button:not([disabled]) { color: #227E94; }
    paper-icon-button::shadow paper-ripple { color: #227E94 !important; }

   
    .space-top { margin-top: 5px; }
    .space-bottom { margin-bottom: 5px; }
    .small-header-text { 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: bold;
    }
    .small-text { font-size: var(--small-text-size); }
    .text-wide { width: var(--text-wide-size); }
    .text-medium { width: var(--text-medium-size); }
    .text-small { width: var(--text-small-size); }

    .milestone-connection { margin-top: 5px; }
    .milestone-container, .milestone-header-container { position: relative; }
    .milestone-container > div:last-of-type { margin-bottom: 0; }
    .milestone-row { margin: 8px 8px 0 8px; }
    .milestone-row .inner { 
      padding: 8px;
      position: relative;
      background: #fff;
      border-radius: 0 0 3px 3px;
    }
    .milestone-element {
      position: relative;
      width: 100%;
      overflow: auto;
      padding: 12px 8px;
      border-radius: 3px;
      box-sizing: border-box;
      background: #fff;
    }
    .milestone-element iron-icon:not(.done) { color: rgb(23, 106, 126); }
    .milestone-element iron-icon.done { color: green; }
    .milestone-row.selected .milestone-element, .milestone-row.selected .milestone-element iron-icon {  
      background: #227E94;
      color: #fff !important;
    }
    .milestone-comment { overflow: auto;  padding-top: 5px;}
  </style>

  <template>
    <div class="menu-container">
      <template is="dom-repeat" items="[[currentErrand.a_milestones]]">
        <div class="milestone-row" data-guid$="[[item.guid]]" data-idx$="[[index]]">
          <div class="milestone-header-container">
            <div class="milestone-element" on-click="_toggleMilestone">
              <iron-icon icon$="[[_getMilestoneIcon(item.done)]]" class$="[[_getMilestoneIconClass(item.done)]]"></iron-icon>&nbsp;<span>[[item.title]]</span>
            </div>
            <div class$="[[_getRemoveIconClass(editMode)]]">
              <paper-fab mini hidden$="[[_isTruthy(item.done)]]" data-id$="[[index]]" disabled$="[[_canModifyMilestoneStatus(currentErrand.status, 'open')]]" on-click="_finishMilestone" class="mark-done" icon="icons:assignment-turned-in"></paper-fab>
              <paper-fab mini hidden$="[[!_isTruthy(item.done)]]" data-id$="[[index]]" disabled$="[[_canModifyMilestoneStatus(currentErrand.status, 'close')]]" on-click="_openMilestone" class="mark-open" icon="icons:assignment"></paper-fab>
            </div>
          </div>
          <iron-collapse duration="0.2" class="iron-collapse-closed">
            <div class="inner">
            <p>
              This is the first test of many. . .
            </p>
              <div class="space-bottom milestone-comment">
                <h3>Anteckning</h3>
                <paper-textarea label="Kommentarer i fritext" maxlength="800" char-counter value$="[[item.s_comment]]"></paper-textarea>
              </div>
            </div>
          </iron-collapse>
        </div>

      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'collapsible-divmenu',

      behaviors: [AppBehavior.helpers,
                  ErrandBehavior.helpers,
                  AppBehavior.checkPrivs,
                  TillsynBehavior.icons
                 ],

      properties: {
        currentErrand: {
          type: Object,
          notify: true
        }
      },

      listeners: {
        'close-milestones': '_closeOpenMilestone',
        'return-from-tillsyn': '_returnTillsyn'
      },
      /*


      // ##############################################################################
      // ########################## CHECK PRIVILEGES ##################################
      // ##############################################################################
      _canModifyMilestoneStatus: function(errandStatus, mode, unused) {
        if (this._checkErrandStatus(errandStatus)) return true; // disable if avslutat

        var requiredPrivs = [79, 11];
        if (mode === 'close') requiredPrivs.push(281);
        if (this._checkPrivs(this.privs, requiredPrivs)) return false;
        return true;
      },

      _canEditMilestone: function(errandStatus, milestoneStatus, searchMode) {
        if (this._checkErrandStatus(errandStatus)) return true; // disable if avslutat
        if (this._isTruthy(milestoneStatus)) return true; // true= disable element
        if (searchMode) return true; // true = disable

        var requiredPrivs = [79, 11];
        if (this._checkPrivs(this.privs, requiredPrivs)) return false;
        return true;
      },

      _canCreateMilestone: function(errandStatus, unused) {
        if (this._checkErrandStatus(errandStatus)) return true; // disable if avslutat

        var requiredPrivs = [79, 11, 179];

        if (this._checkPrivs(this.privs, requiredPrivs)) return false;
        return true;
      },

      _canDeleteMilestone: function(errandStatus, status, unused) {
        if (this._checkErrandStatus(errandStatus)) return true; // disable if avslutat

        var requiredPrivs = [79, 11, 12];
        if (status == 0) requiredPrivs.push(282);

        if (this._checkPrivs(this.privs, requiredPrivs)) return false;
        return true;
      },
      */


      // ##############################################################################
      // ########################## EVENT HANDLERS ####################################
      // ##############################################################################
     

      _toggleMilestone: function(e) {
        var clickedParent = LPA.closestAncestor(e.target, ".milestone-row") || e.target;
        var milestoneDetails = clickedParent.querySelector("iron-collapse");

        // Get all rows with iron-collapse in them
        var allMilestoneElems = document.querySelectorAll("div.milestone-row iron-collapse");
        for (var i = 0, len = allMilestoneElems.length; i < len; i++) {
          var elem = allMilestoneElems[i];
          if (elem.opened && elem !== milestoneDetails) {
            // If any other element is opened, close it.
            elem.toggle();
            // Deselect the parent element
            elem.parentElement.classList.remove('selected');
          }
        }

        // Toggle this element
        milestoneDetails.toggle();

        if (milestoneDetails.opened) {
          clickedParent.classList.add('selected');
        } else {
          clickedParent.classList.remove('selected');
        }
      },

      _finishMilestone: function(evt) {
        evt.stopPropagation();
        
        var btn = LPA.closestAncestor(evt.target, 'paper-fab') || evt.target;
        if (btn.getAttribute('confirm-click')) {
          btn.removeAttribute('confirm-click');
          this.fire('hide-toast');
          this._modifyMilestoneStatus(btn, 1);
          this._setMilestoneDateToNow(evt);

        } else {
          btn.setAttribute('confirm-click', true);
          this.fire('show-toast', 'Tryck igen för att klarmarkera åtgärd');
        }
        this.fire('extend-timeout');
      },

      _openMilestone: function(evt) {
        evt.stopPropagation();

        var btn = LPA.closestAncestor(evt.target, 'paper-fab') || evt.target;
        if (btn.getAttribute('confirm-click')) {
          btn.removeAttribute('confirm-click');
          this.fire('hide-toast');
          this._modifyMilestoneStatus(btn, 0);
        } else {
          btn.setAttribute('confirm-click', true);
          this.fire('show-toast', 'Tryck igen för att öppna åtgärd');
        }
        this.fire('extend-timeout');
      },
      _closeOpenMilestone: function() {
        var selectedMilestone = this.querySelector('.milestone-row.selected');
        if (selectedMilestone && selectedMilestone.classList.contains('selected')) {
          selectedMilestone.classList.remove('selected');
          selectedMilestone.querySelector('iron-collapse').toggle();
        }
      }

    });
  </script>
</dom-module>